@use super::misc::base;
@use super::statics;
@use super::misc::csrf_input;
@use crate::models::content::Content as PostContent;
@use crate::models::comment::Author;
@use crate::render::*;

@(ctx: &GlobalContext, title: &str, post: PostContent, previous_author: Option<Author>)

@:base(ctx, title, {}, {
	<link href="/static/theme/@statics::comment_css.name" rel="stylesheet" />
}, {
	<h1><a href="@post.get_link()">@if let Some(t) = &post.title {@t} else {Untitled}</a></h1>
	<small>by @(post.get_user(&ctx.db).unwrap().name) in @if let Some(cat_name) = &post.get_category_name(&ctx.db).unwrap() {@cat_name} else {Uncategorized} · @date_format(&post.time, "%Y-%m-%d")</small>
	<article>
		@:markdown_to_html(&post.content.as_str())
	</article>
	<hr />
	<p><small>Tags:</small> @(post.get_tags_name(&ctx.db).unwrap().join(", "))</p>
	<hr />
	<p>
		<b>上一篇: </b>
		@if let Some(p) = post.find_neighbor_post(&ctx.db, true, 1).unwrap() {
		<a href="@p.get_link()">@if let Some(t) = &p.title {@t} else {Untitled}</a>
		} else {
		<i>没有了</i>
		}
	</p>
	<p>
		<b>下一篇: </b>
		@if let Some(p) = post.find_neighbor_post(&ctx.db, false, 1).unwrap() {
		<a href="@p.get_link()">@if let Some(t) = &p.title {@t} else {Untitled}</a>
		} else {
		<i>没有了</i>
		}
	</p>
	<hr />
	<div>@if let Ok(comments) = &post.get_parent_comments(&ctx.db) {
		<h1>Comments</h1>
		<div id="comment-form-wrapper">
			<form id="comment-form" action="@post.get_comment_url()" method="POST">
				@:csrf_input(ctx)
				@if let Some(u) = &ctx.user {<i>You are logged in as @u.name</i>} else {
					<p><input type="text" name="name" placeholder="Your name" @if let Some(o) = &previous_author {value="@o.name" }/></p>
					<p><input type="text" name="mail" placeholder="Your e-mail" @if let Some(o) = &previous_author {@if let Some(s) = &o.mail {value="@s" }}/></p>
					<p><input type="text" name="link" placeholder="Your website"  @if let Some(o) = &previous_author {@if let Some(s) = &o.link {value="@s" }}/></p>
				}<br />
				<textarea name="text"></textarea>
				<input type="submit" value="Send!" /><button id="cancel-reply" style="display: none;">Cancel Reply</button>
			</form>
		</div>
		@for comment in comments {<div class="comment">
			<p>@:nl2br(comment.text.as_str())</p>
			<small>by @comment.author_name @@ @date_format(&comment.time, "%Y-%m-%d %H:%M:%S")</small> <button class="reply-to-comment" data-id="@comment.id">Reply</button>
			@if let Ok(comments) = &comment.get_children(&ctx.db) {
				@for comment in comments {<div class="comment">
					<p>@:nl2br(comment.text.as_str())</p>
					<small>by @comment.author_name @@ @date_format(&comment.time, "%Y-%m-%d %H:%M:%S")</small> <button class="reply-to-comment" data-id="@comment.id">Reply</button>
				</div>}
		}</div>}
	}</div>
}, {
	<script src="/static/theme/@statics::jquery_3_4_1_min_js.name"></script>
	<script src="/static/theme/@statics::comment_js.name"></script>
})
